# Prometheus, gitlab 내장 Prometheus sdb로 옮기는 과정에서 깨달은 점(?)

또 다시 Root FS Used가 90%를 찍었다.(눈물)

Prometheus, gitlab 내장 prometheus의 영향이 컸다.

이번에도 의식의 흐름 기법인 것을 감안해주시길 바란다.

```
sudo du -ahx / | sort -rh | head -n 20
```

이렇게 명령어를 치면 루트 파티션 내에서 상위 20개 용량 차지 경로를 보여준다.

**전부 prometheus 관련 경로들이었다.**

저 명령어들을 파헤쳐 보자.

du : disk usage (디렉토리/파일의 실제 사용량 계산)

-a : 파일과 디렉토리 모두 출력
-h : 사람이 읽기 좋은 단위로 표시(K, M, G 단위)
-x : 현재 파일 시스템만 계산(다른 파티션/마운트 포인트는 무시)
/ : 조사 시작 경로를 루트로 지정

즉, 루트부터 시작해서 모든 파일과 디렉토리의 크기를 한 줄씩 출력한다.

| : 앞 명령어의 결과를 뒤 명령어의 입력으로 전달한다.

sort : 정렬

-r : 내림차순 정렬
-h : 사람이 읽기 좋은 단위로 표시

head -n 20 : 출력 결과의 앞 20줄만 표시

## 계획

일단 dev/sda3에 있는 gitlab/prometheus 관련 폴더를 sdb로 옮기고, 외부 prometheus 역시 sdb로 옮기기로 했다.

그러기 위해선 sdb2에 120G 가량 할당되어 있는 것을 50G로 줄이고, 그 안에 gitlab 관련 용량을 많이 차지 하는 것들을 옮겨두고, sdb3 파티션을 만들어 Prometheus 관련 데이터를 저장하는 폴더를 마운트 해야 했다.

생각해보니까 왜 sdb2에 120G 할당된거 죄다 때려박으면 되지 뭣하러 귀찮게 파티션을 나누었는지 갑자기 그런 생각이 든다.

그래서 GPT한테 물어보았다.

가장 눈에 띄는 이유는 성능 분리렸다.

GPT의 말에 따르면 I/O 패턴이 다른 프로그램을 같은 파티션에 두면 성능 저하가 발생할 수 있고, 그래서 파티션을 분리하면 파일 시스템 캐시와 I/O 스케줄링이 서로 간섭을 덜 한다고 한다.

```
같은 파티션은 즉 같은 파일 시스템이다.

/dev/sdb2  → ext4 파일 시스템  → /mnt/gitlab
/dev/sdb3  → ext4 파일 시스템  → /mnt/prometheus

여기서 /mnt/gitlab과 /mnt/prometheus는 서로 다른 파일 시스템을 사용한다.

보통 파티션 생성 -> 파일 시스템 포맷 -> 마운트 순서로 진행되는 것을 생각하면 서로 다른 파일 시스템인것이 맞다.
```

## 그럼 왜 같은 파티션에 두면 성능 저하가 발생할까?

같은 디스크(특히 HDD, 단일 SSD 파티션) 안에 Gitlab 데이터와 Prometheus 데이터를 같이 두면, 저장장치의 물리적, 논리적 I/O 특성 때문에 성능 저하가 발생한다고 한다.

### 1. I/O 패턴 충돌
GitLab → 작은 파일(커밋, 메타데이터, DB) 위주로 읽고 쓰는 랜덤 I/O

Prometheus → 타임시리즈 데이터에 계속 기록하는 순차 I/O

같은 디스크에 있으면 OS I/O 스케줄러가 랜덤 I/O ↔ 순차 I/O 요청을 번갈아 처리해야 해서
→ 디스크 헤드 이동(HDD)이나 메모리 블록 매핑(SSD) 전환이 자주 발생
→ 순차 쓰기 성능이 끊기고, 랜덤 읽기 성능도 떨어짐

### 2. 디스크 캐시·버퍼 경합
디스크와 OS는 쓰기 캐시·페이지 캐시를 사용해서 속도를 높이는데,
두 서비스의 데이터가 같은 캐시 공간을 경쟁적으로 사용하면 서로의 캐시 히트율이 떨어짐

결과적으로 디스크에 직접 읽기/쓰기가 더 자주 발생 → 속도 저하

### 3. 파일시스템 Lock 경합
같은 파티션(같은 파일시스템)에 있으면 메타데이터 업데이트, 저널링(Journaling) 같은 작업이 **공유 락(locks)**을 걸어야 해서, 서로가 대기 상태에 빠질 수 있음

같은 파일 시스템(하나의 파티션 안)에서는 메타데이터 영역이 하나이다. 그래서 두개의 프로세스가 동시에 이 영역을 변경하려 하면 동시에 메타데이터 구조체를 건드리게 된다면 데이터 구조가 깨질 위험이 있다.

저널링의 경우에도 메타데이터 변경을 먼저 저널 영역에 기록한 뒤 실제 데이터 영역에 반영하는 방식이라 이 과정에서도 락이 필요하다. 두 요청이 저널에 기록하는 순서가 꼬이게 되면 시스템이 복구할때 어느 변경이 먼저였는지 알 수 없고, 동시에 쓰게 되면 저널이 손상될 수도 있다.

```
저널링?

전원이 꺼지거나 장애 발생시 파일 시스템 손상을 방지하는 역할을 한다. 변경 사항을 먼저 저널에 기록하고, 안전하면 실제 데이터에 반영한다. 리눅스의 파일시스템인 ext4는 저널링을 지원한다.
```

## 결론

어쨌든 파티션을 분리해서 각기 다른 파일 시스템으로 동작하도록 하는게 맞는 것 같다.

이제 prometheus 설정을 좀 만져서 메트릭들이 많이 쌓이지 않도록 관리하고 또 스터디 해야 할 것 같다.

기껏 나눠놨더니 그냥 gitlab과 prometheus 서버를 분리하라고 하셨다.

그게 정신건강에도 이로울것같다. 

근데 gitlab전부 sdb로 옮겨야 하는데 어느 세월에 옮기지?
